package controller;

import java.io.File;
import java.io.IOException;

import epi.ServerInterface;
import model.GeneralInfoModel;
import view.IlluminaView;
import jxl.Workbook;
import jxl.read.biff.BiffException;
import jxl.write.Label;
import jxl.write.WritableSheet;
import jxl.write.WritableWorkbook;
import jxl.write.WriteException;
import jxl.write.biff.RowsExceededException;

public class IlluminaController extends MicroarrayController{
	private IlluminaView _view;
	
	private static IlluminaController instance = null;
	
	private IlluminaController(){
		_view = IlluminaView.getInstance();
		_view.get_generateBtn().addActionListener(new GenerateActionListener());
	}
	
	public static IlluminaController getInstance(){
		if(instance == null){
			instance = new IlluminaController();
		}
		return instance;
	}
	
	public IlluminaView get_view() {
		return _view;
	}
	public void set_view(IlluminaView _view) {
		this._view = _view;
	}

	@Override
	public void experimentListChange(int index, String value) {
		// TODO Auto-generated method stub
		
	}
	
	@Override
	public void reset() {
		_view.get_labelProtocolTxtArea().setText(null);
		_view.get_hybProtocolTxtArea().setText(null);
		_view.get_scanProtocolTxtArea().setText(null);
		_view.get_growthProtocolTxtArea().setText(null);
		_view.get_treatmentProtocolTxtArea().setText(null);
		_view.get_dataProcessingTxtArea().setText(null);
		_view.get_extractProtocolTxtArea().setText(null);
		_view.get_dataProcessingTxtArea().setText(null);
		_view.get_matrixProcessedTxtArea().setText(null);
		_view.get_matrixSignalTxtArea().setText(null);
	}

	@Override
	public void enable() {
		_view.get_labelProtocolTxtArea().setEnabled(true);
		_view.get_hybProtocolTxtArea().setEnabled(true);
		_view.get_scanProtocolTxtArea().setEnabled(true);
		_view.get_growthProtocolTxtArea().setEnabled(true);
		_view.get_treatmentProtocolTxtArea().setEnabled(true);
		_view.get_dataProcessingTxtArea().setEnabled(true);
		_view.get_extractProtocolTxtArea().setEnabled(true);
		_view.get_dataProcessingTxtArea().setEnabled(true);
		_view.get_matrixProcessedTxtArea().setEnabled(true);
		_view.get_matrixSignalTxtArea().setEnabled(true);
	}

	@Override
	public void disable() {
		_view.get_labelProtocolTxtArea().setEnabled(false);
		_view.get_hybProtocolTxtArea().setEnabled(false);
		_view.get_scanProtocolTxtArea().setEnabled(false);
		_view.get_growthProtocolTxtArea().setEnabled(false);
		_view.get_treatmentProtocolTxtArea().setEnabled(false);
		_view.get_dataProcessingTxtArea().setEnabled(false);
		_view.get_extractProtocolTxtArea().setEnabled(false);
		_view.get_dataProcessingTxtArea().setEnabled(false);
		_view.get_matrixProcessedTxtArea().setEnabled(false);
		_view.get_matrixSignalTxtArea().setEnabled(false);
	}

	@Override
	public void generate() throws RowsExceededException, WriteException, IOException, BiffException {
		GeneralInfoModel info = GeneralInfoModel.getInstance();
		
		ServerInterface.getInstance().get_stub().createIlluminaDirectory(info.get_species(), info.get_description(), 
				info.get_title(), info.get_project().get_original_folder(), info.get_title(), info.get_summary(), 
				info.get_overall_design(), info.get_contributor(), _view.get_growthProtocolTxtArea().getText(), 
				_view.get_treatmentProtocolTxtArea().getText(), _view.get_extractProtocolTxtArea().getText(), 
				_view.get_labelProtocolTxtArea().getText(), _view.get_hybProtocolTxtArea().getText(), 
				_view.get_scanProtocolTxtArea().getText(), _view.get_dataProcessingTxtArea().getText(), 
				_view.get_matrixProcessedTxtArea().getText(), _view.get_matrixSignalTxtArea().getText());
		
		String folder_name = get_folder_name(info.get_title(),info.get_species(),info.get_description(),info.get_project(), info.get_current_absolute_path())+"/";
		create_folder(folder_name);
		
		Workbook template = Workbook.getWorkbook(getClass().getClassLoader().getResourceAsStream("GA_illumina.xls"));
		WritableWorkbook wbCopy = Workbook.createWorkbook(new File(folder_name+"metadata.xls"),template);
		
		WritableSheet sheet = wbCopy.getSheet("Metadata Template");
		
		sheet.addCell(new Label(1,9,info.get_title()));
		sheet.addCell(new Label(1,10,info.get_summary()));
		sheet.addCell(new Label(1,11,info.get_overall_design()));
		sheet.addCell(new Label(1,12,info.get_contributor()));
		
		sheet.addCell(new Label(1,31,_view.get_growthProtocolTxtArea().getText()));
		sheet.addCell(new Label(1,32,_view.get_treatmentProtocolTxtArea().getText()));
		sheet.addCell(new Label(1,33,_view.get_extractProtocolTxtArea().getText()));
		sheet.addCell(new Label(1,34,_view.get_labelProtocolTxtArea().getText()));
		sheet.addCell(new Label(1,35,_view.get_hybProtocolTxtArea().getText()));
		sheet.addCell(new Label(1,36,_view.get_scanProtocolTxtArea().getText()));
		sheet.addCell(new Label(1,37,_view.get_dataProcessingTxtArea().getText()));
		sheet.addCell(new Label(1,38,_view.get_matrixProcessedTxtArea().getText()));
		sheet.addCell(new Label(1,39,_view.get_matrixSignalTxtArea().getText()));
		wbCopy.write();
		wbCopy.close();
	}
	
}
